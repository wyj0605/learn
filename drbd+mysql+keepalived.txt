keepalived.conf内容如下：

! Configuration File for keepalived
global_defs {
   router_id LVS_DEVEL
}
vrrp_script check_mysql {
        script "/data/sh/check_mysql.sh"
        interval 5
        }
vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 52
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.149.100
         }
        track_script {
        check_mysql
        }
}
 然后创建check_mysql.sh检测脚本，内容如下：
1
2
3
4
5
6
7
8
#!/bin/sh
A=`ps -C mysqld --no-header |wc -l`
if
[ $A -eq 0 ];then
/bin/umount /app/
drbdadm secondary r0
killall keepalived
fi
添加node2（backup）上配置，keepalived.conf内容如下：

! Configuration File for keepalived
global_defs {
   router_id LVS_DEVEL
}
vrrp_sync_group VI{
group {
      VI_1
}
notify_master /data/sh/master.sh
notify_backup /data/sh/backup.sh
}
vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id 52
    priority 90
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.149.100
         }
}
  创建master.sh检测脚本，内容如下：
1
2
3
4
#!/bin/bash
drbdadm primary r0
/bin/mount /dev/drbd0 /app/
/etc/init.d/mysqld start
  创建backup.sh检测脚本，内容如下：
1
2
3
4
#!/bin/bash
/etc/init.d/mysqld stop
/bin/umount /dev/drbd0
drbdadm secondary r0
  发生脑裂恢复步骤如下：
1
2
3
4
5
Master执行命令：
drbdadm  secondary r0
drbdadm  --  --discard-my-data  connect r0
Backup上执行命令：
drbdadm  connect r0